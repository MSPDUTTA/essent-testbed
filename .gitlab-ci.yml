image: openjdk:8

build:
  stage: build
  before_script:
    # Enable the usage of sources over https
    - apt-get update -yqq
    - apt-get install apt-transport-https -yqq
    # Install g++
    - apt-get install g++ -yqq
    - g++ --version
    # Add keyserver for SBT
    - echo "deb http://dl.bintray.com/sbt/debian /" | tee -a /etc/apt/sources.list.d/sbt.list
    - apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 642AC823
    # Install SBT
    - apt-get update -yqq
    - apt-get install sbt -yqq
    # Install make
    - apt-get install make
    # Build riscv-fesvr
    - mkdir riscv
    - cd riscv; export RISCV=`pwd`; cd ..
    - git clone https://github.com/riscv/riscv-fesvr.git
    - cd riscv-fesvr
    - git checkout 18e712bc9931c49c101d27219f196f499b64c95e
    - ./configure --prefix=$RISCV
    - make install
    - cd ..
    # Update submodules
    - git submodule update --init
    # Prime sbt
    - cd essent
    - sbt sbtVersion
    - cd ..
  script:
    - cd rocket
    - time make emulator
  artifacts:
    paths:
      - rocket/emulator
      - riscv/

test:
  stage: test
  before_script:
    # Re-establish RISCV variable
    - cd riscv; export RISCV=`pwd`; cd ..
  script:
    - cd rocket
    - time ./emulator +cycle-count ./dhrystone.riscv
